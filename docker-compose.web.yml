# Optional web interface services. Use with:
# docker compose -f docker-compose.yml -f docker-compose.web.yml up -d --build

services:
  # Web Interface Service (Optional - only needed if you want the web UI)
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: isobel-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3001}:3001"
    volumes:
      - ./data:/data:de # Read-only access to bot data
    environment:
      # Web server configuration
      - NODE_ENV=production
      - PORT=3001

      # Database (required - must be PostgreSQL)
      - DATABASE_URL=${DATABASE_URL}

      # Discord OAuth (required for web interface)
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3001}

      # Optional: Bot health endpoint
      - BOT_HEALTH_URL=${BOT_HEALTH_URL:-http://bot:3002/health}
      - DATA_DIR=/data
    networks:
      - isobel-network
    depends_on:
      - bot
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health", "||", "exit", "1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Auth Server Service (Optional - required by web interface)
  auth:
    build:
      context: ./web
      dockerfile: Dockerfile.auth
    container_name: isobel-auth
    restart: unless-stopped
    ports:
      - "${AUTH_PORT:-3003}:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003

      # Database (required for NextAuth sessions)
      - DATABASE_URL=${DATABASE_URL}

      # NextAuth configuration
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3003}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}

      # Discord OAuth
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
    networks:
      - isobel-network
    depends_on:
      - bot
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health", "||", "exit", "1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
