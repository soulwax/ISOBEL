version: '3.8'

services:
  # Discord Bot Service
  bot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        COMMIT_HASH: ${COMMIT_HASH:-local}
        BUILD_DATE: ${BUILD_DATE:-now}
    container_name: isobel-bot
    restart: unless-stopped
    volumes:
      - ./data:/data
      # Optional: Mount .env file if you prefer file-based config
      # - ./.env:/config:ro
    environment:
      # Required: Discord and Starchild API credentials
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - SONGBIRD_BASE_URL=${SONGBIRD_BASE_URL}
      - SONGBIRD_API_KEY=${SONGBIRD_API_KEY}

      # Optional: Bot configuration
      - DATA_DIR=/data
      - CACHE_LIMIT=${CACHE_LIMIT:-2GB}
      - BOT_STATUS=${BOT_STATUS:-online}
      - BOT_ACTIVITY_TYPE=${BOT_ACTIVITY_TYPE:-LISTENING}
      - BOT_ACTIVITY=${BOT_ACTIVITY:-music}
      - ENABLE_SPONSORBLOCK=${ENABLE_SPONSORBLOCK:-false}

      # Environment
      - NODE_ENV=production
    networks:
      - isobel-network
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Web Interface Service (Optional - only needed if you want the web UI)
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: isobel-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3001}:3001"
    volumes:
      - ./data:/data:ro  # Read-only access to bot data
    environment:
      # Web server configuration
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=file:/data/database.sqlite

      # Discord OAuth (required for web interface)
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3001}

      # Optional: Point to the bot's database
      - DATA_DIR=/data
    networks:
      - isobel-network
    depends_on:
      - bot
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - with-web  # Only start if 'with-web' profile is specified

  # Auth Server Service (Optional - required by web interface)
  auth:
    build:
      context: ./web
      dockerfile: Dockerfile.auth
    container_name: isobel-auth
    restart: unless-stopped
    ports:
      - "${AUTH_PORT:-3003}:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3001}
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
    networks:
      - isobel-network
    depends_on:
      - bot
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - with-web  # Only start if 'with-web' profile is specified

networks:
  isobel-network:
    driver: bridge

volumes:
  data:
    driver: local
